version: "3.9"

services:

  qdrant:
    image: qdrant/qdrant
    ports:
      - "6334:6333"
    volumes:
      # Separate volume for Qdrant — do NOT share with Ollama
      - ../memory/qdrant:/qdrant/storage
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/healthz"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 15s

  ollama:
    image: ollama/ollama
    ports:
      - "11435:11434"
    volumes:
      # Separate volume for Ollama — do NOT share with Qdrant
      - ../memory/ollama:/root/.ollama
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  bot:
    build: ./bot
    depends_on:
      qdrant:
        condition: service_healthy
      ollama:
        condition: service_healthy
    environment:
      # Set BOT_TOKEN in .env file — never hardcode
      - BOT_TOKEN=${BOT_TOKEN}
      # Also expose as TELEGRAM_BOT_TOKEN for the services layer
      - TELEGRAM_BOT_TOKEN=${BOT_TOKEN}
      # Internal Docker network URLs (container port, not host port)
      - OLLAMA_URL=http://ollama:11434/api/generate
      - QDRANT_URL=http://qdrant:6333
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama3}
    volumes:
      - ../identity:/app/identity:ro
      - ../logs:/app/logs
    restart: unless-stopped
